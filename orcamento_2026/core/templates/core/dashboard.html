{% extends "base.html" %}
{% load humanize %}
{% block title %}Dashboard - Orçamento 2026{% endblock %}

{% block content %}
    <div class="space-y-8">
        <!-- Header -->
        <div class="md:flex md:items-center md:justify-between">
            <div class="min-w-0 flex-1">
                <h2 class="text-2xl font-bold text-slate-900 tracking-tight">Dashboard</h2>
                <p class="mt-1 text-sm text-slate-500">Visão geral e indicadores do seu orçamento.</p>
            </div>
            <div class="mt-4 flex md:ml-4 md:mt-0">
                <form method="get"
                      class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3">
                    <div class="relative">
                        <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                            <span class="text-slate-400 sm:text-sm font-medium">De</span>
                        </div>
                        <input type="date"
                               name="start_date"
                               id="id_start_date"
                               value="{{ start_date|date:'Y-m-d' }}"
                               class="block w-full rounded-xl border-0 py-2.5 pl-10 text-slate-900 ring-1 ring-inset ring-slate-200 placeholder:text-slate-400 focus:ring-2 focus:ring-inset focus:ring-indigo-500 sm:text-sm shadow-sm bg-white">
                    </div>
                    <div class="relative">
                        <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                            <span class="text-slate-400 sm:text-sm font-medium">Até</span>
                        </div>
                        <input type="date"
                               name="end_date"
                               id="id_end_date"
                               value="{{ end_date|date:'Y-m-d' }}"
                               class="block w-full rounded-xl border-0 py-2.5 pl-10 text-slate-900 ring-1 ring-inset ring-slate-200 placeholder:text-slate-400 focus:ring-2 focus:ring-inset focus:ring-indigo-500 sm:text-sm shadow-sm bg-white">
                    </div>
                    <button type="submit"
                            class="inline-flex items-center justify-center rounded-xl bg-slate-900 px-4 py-2.5 text-sm font-semibold text-white shadow-sm hover:bg-slate-700 transition-all duration-200">
                        <svg class="-ml-0.5 mr-1.5 h-4 w-4"
                             viewBox="0 0 20 20"
                             fill="currentColor">
                            <path fill-rule="evenodd" d="M2.628 1.601C5.028 1.206 7.49 1 10 1s4.973.206 7.372.601a.75.75 0 01.628.74v2.288a2.25 2.25 0 01-.659 1.59l-4.682 4.683a2.25 2.25 0 00-.659 1.59v3.037c0 .684-.31 1.33-.844 1.757l-1.937 1.55A.75.75 0 018 18.25v-5.757a2.25 2.25 0 00-.659-1.591L2.659 6.22A2.25 2.25 0 012 4.629V2.34a.75.75 0 01.628-.74z" clip-rule="evenodd" />
                        </svg>
                        Filtrar
                    </button>
                </form>
            </div>
        </div>
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4">
            <!-- Total Despesas -->
            <div class="group relative overflow-hidden rounded-2xl bg-white p-6 shadow-sm ring-1 ring-slate-900/5 transition-all duration-300 hover:shadow-md hover:-translate-y-0.5">
                <div class="absolute inset-x-0 top-0 h-1 bg-gradient-to-r from-indigo-500 to-indigo-600"></div>
                <div class="flex items-center gap-4">
                    <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-indigo-50 text-indigo-600 group-hover:bg-indigo-100 transition-colors">
                        <svg class="h-6 w-6"
                             fill="none"
                             viewBox="0 0 24 24"
                             stroke-width="1.5"
                             stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                        </svg>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-slate-500">Total de Despesas</p>
                        <p class="text-2xl font-bold text-slate-900 mt-0.5">{{ total_expenses }}</p>
                    </div>
                </div>
            </div>
            <!-- Valor Total -->
            <div class="group relative overflow-hidden rounded-2xl bg-white p-6 shadow-sm ring-1 ring-slate-900/5 transition-all duration-300 hover:shadow-md hover:-translate-y-0.5">
                <div class="absolute inset-x-0 top-0 h-1 bg-gradient-to-r from-emerald-500 to-emerald-600"></div>
                <div class="flex items-center gap-4">
                    <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-emerald-50 text-emerald-600 group-hover:bg-emerald-100 transition-colors">
                        <svg class="h-6 w-6"
                             fill="none"
                             viewBox="0 0 24 24"
                             stroke-width="1.5"
                             stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m-3-2.818l.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-slate-500">Valor Total</p>
                        <p class="text-2xl font-bold text-slate-900 mt-0.5">R$ {{ total_amount|intcomma }}</p>
                    </div>
                </div>
            </div>
            <!-- Não Consolidadas -->
            <div class="group relative overflow-hidden rounded-2xl bg-white shadow-sm ring-1 ring-slate-900/5 transition-all duration-300 hover:shadow-md hover:-translate-y-0.5">
                <div class="absolute inset-x-0 top-0 h-1 bg-gradient-to-r from-amber-500 to-orange-500"></div>
                <div class="flex flex-col h-full">
                    <div class="p-6 flex-grow">
                        <div class="flex items-center gap-4">
                            <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-amber-50 text-amber-600 group-hover:bg-amber-100 transition-colors">
                                <svg class="h-6 w-6"
                                     fill="none"
                                     viewBox="0 0 24 24"
                                     stroke-width="1.5"
                                     stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-slate-500">Não Consolidadas</p>
                                <p class="text-2xl font-bold text-slate-900 mt-0.5">{{ unconsolidated_count }}</p>
                            </div>
                        </div>
                    </div>
                    {% if unconsolidated_count > 0 %}
                        <div class="bg-slate-50 px-6 py-3 border-t border-slate-100">
                            <a href="{% url 'transaction_list' %}?has_expense=no"
                               class="text-sm font-medium text-amber-600 hover:text-amber-700 flex items-center gap-1 transition-colors">
                                Ver transações <span>&rarr;</span>
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
            <!-- Sugestões Larry -->
            <div class="group relative overflow-hidden rounded-2xl bg-white shadow-sm ring-1 ring-slate-900/5 transition-all duration-300 hover:shadow-md hover:-translate-y-0.5">
                <div class="absolute inset-x-0 top-0 h-1 bg-gradient-to-r from-purple-500 to-pink-500"></div>
                <div class="flex flex-col h-full">
                    <div class="p-6 flex-grow">
                        <div class="flex items-center gap-4">
                            <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-purple-50 text-purple-600 group-hover:bg-purple-100 transition-colors">
                                <svg class="h-6 w-6"
                                     fill="none"
                                     viewBox="0 0 24 24"
                                     stroke-width="1.5"
                                     stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.894 20.567L16.5 21.75l-.394-1.183a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 001.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 001.423 1.423l1.183.394-1.183.394a2.25 2.25 0 00-1.423 1.423z" />
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-slate-500">Sugestões Larry</p>
                                <p class="text-2xl font-bold text-slate-900 mt-0.5">{{ pending_suggestions }}</p>
                            </div>
                        </div>
                    </div>
                    {% if pending_suggestions > 0 %}
                        <div class="bg-slate-50 px-6 py-3 border-t border-slate-100">
                            <a href="{% url 'suggestion_list' %}"
                               class="text-sm font-medium text-purple-600 hover:text-purple-700 flex items-center gap-1 transition-colors">
                                Ver sugestões <span>&rarr;</span>
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        <!-- Charts Row 1 -->
        <div class="grid grid-cols-1 gap-6 lg:grid-cols-2">
            <!-- Donut Chart -->
            <div class="overflow-hidden rounded-2xl bg-white shadow-sm ring-1 ring-slate-900/5">
                <div class="px-6 py-5 border-b border-slate-100">
                    <h3 class="text-sm font-semibold text-slate-900">Despesas por Categoria</h3>
                </div>
                <div class="p-6">
                    <div id="donut-chart"></div>
                </div>
            </div>
            <!-- Area Chart -->
            <div class="overflow-hidden rounded-2xl bg-white shadow-sm ring-1 ring-slate-900/5">
                <div class="px-6 py-5 border-b border-slate-100">
                    <h3 class="text-sm font-semibold text-slate-900">Evolução Mensal</h3>
                </div>
                <div class="p-6">
                    <div id="area-chart"></div>
                </div>
            </div>
        </div>
        <!-- Charts Row 2 -->
        <div class="grid grid-cols-1 gap-6 lg:grid-cols-2">
            <!-- Horizontal Bar Chart -->
            <div class="overflow-hidden rounded-2xl bg-white shadow-sm ring-1 ring-slate-900/5">
                <div class="px-6 py-5 border-b border-slate-100">
                    <h3 class="text-sm font-semibold text-slate-900">Top Subcategorias</h3>
                </div>
                <div class="p-6">
                    <div id="hbar-chart"></div>
                </div>
            </div>
            <!-- Vertical Bar Chart -->
            <div class="overflow-hidden rounded-2xl bg-white shadow-sm ring-1 ring-slate-900/5">
                <div class="px-6 py-5 border-b border-slate-100">
                    <h3 class="text-sm font-semibold text-slate-900">Despesas por Conta</h3>
                </div>
                <div class="p-6">
                    <div id="vbar-chart"></div>
                </div>
            </div>
        </div>
    </div>
{% endblock content %}

{% block extra_js %}
    <script>
    // Shared ApexCharts theme
    var chartFont = { fontFamily: 'Inter, system-ui, sans-serif' };
    var chartColors = ['#6366f1', '#8b5cf6', '#ec4899', '#f97316', '#10b981', '#06b6d4', '#a855f7', '#f59e0b'];

    // 1. Donut Chart — Despesas por Categoria
    var pieRaw = {{ pie_chart|safe }};
    if (pieRaw.labels.length > 0) {
        new ApexCharts(document.querySelector('#donut-chart'), {
            chart: { type: 'donut', height: 350, fontFamily: chartFont.fontFamily,
                     animations: { enabled: true, easing: 'easeinout', speed: 800 } },
            series: pieRaw.series,
            labels: pieRaw.labels,
            colors: chartColors,
            plotOptions: {
                pie: {
                    donut: {
                        size: '60%',
                        labels: {
                            show: true,
                            total: {
                                show: true, label: 'Total',
                                formatter: function(w) {
                                    return 'R$ ' + w.globals.seriesTotals.reduce((a,b) => a+b, 0).toLocaleString('pt-BR', {minimumFractionDigits: 0, maximumFractionDigits: 0});
                                }
                            }
                        }
                    }
                }
            },
            dataLabels: { enabled: false },
            legend: { position: 'bottom', fontFamily: chartFont.fontFamily, fontSize: '12px',
                      labels: { colors: '#64748b' },
                      markers: { size: 5, shape: 'circle', offsetX: -2 } },
            stroke: { width: 2, colors: ['#fff'] },
            tooltip: {
                y: { formatter: function(v) { return 'R$ ' + v.toLocaleString('pt-BR', {minimumFractionDigits:2}); } }
            }
        }).render();
    } else {
        document.querySelector('#donut-chart').innerHTML = '<div class="flex items-center justify-center h-[350px] text-sm text-slate-400">Sem dados para o período selecionado</div>';
    }

    // 2. Area Chart — Evolução Mensal
    var lineRaw = {{ line_chart|safe }};
    if (lineRaw.series.length > 0) {
        new ApexCharts(document.querySelector('#area-chart'), {
            chart: { type: 'area', height: 350, fontFamily: chartFont.fontFamily, toolbar: { show: false },
                     animations: { enabled: true, easing: 'easeinout', speed: 800 },
                     zoom: { enabled: false } },
            series: [{ name: 'Despesas', data: lineRaw.series }],
            xaxis: { categories: lineRaw.categories,
                     labels: { style: { colors: '#94a3b8', fontSize: '11px' } },
                     axisBorder: { show: false }, axisTicks: { show: false } },
            yaxis: { labels: { style: { colors: '#94a3b8', fontSize: '11px' },
                               formatter: function(v) { return 'R$ ' + v.toLocaleString('pt-BR', {minimumFractionDigits:0}); } } },
            colors: ['#6366f1'],
            fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.4, opacityTo: 0.05, stops: [0, 90, 100] } },
            stroke: { curve: 'smooth', width: 3 },
            markers: { size: 5, colors: ['#4f46e5'], strokeColors: '#fff', strokeWidth: 2, hover: { size: 7 } },
            dataLabels: { enabled: true, formatter: function(v) { return 'R$ ' + v.toLocaleString('pt-BR', {minimumFractionDigits:0}); },
                          offsetY: -8, style: { fontSize: '11px', colors: ['#334155'] },
                          background: { enabled: false } },
            grid: { borderColor: '#f1f5f9', strokeDashArray: 4, xaxis: { lines: { show: false } } },
            tooltip: {
                y: { formatter: function(v) { return 'R$ ' + v.toLocaleString('pt-BR', {minimumFractionDigits:2}); } }
            }
        }).render();
    } else {
        document.querySelector('#area-chart').innerHTML = '<div class="flex items-center justify-center h-[350px] text-sm text-slate-400">Sem dados para o período selecionado</div>';
    }

    // 3. Horizontal Bar — Top Subcategorias
    var barRaw = {{ bar_chart|safe }};
    if (barRaw.series.length > 0) {
        new ApexCharts(document.querySelector('#hbar-chart'), {
            chart: { type: 'bar', height: Math.max(250, barRaw.categories.length * 42), fontFamily: chartFont.fontFamily,
                     toolbar: { show: false },
                     animations: { enabled: true, easing: 'easeinout', speed: 600 } },
            series: [{ name: 'Total', data: barRaw.series }],
            xaxis: { categories: barRaw.categories,
                     max: Math.max(...barRaw.series) * 1.25,
                     labels: { style: { colors: '#94a3b8', fontSize: '11px' },
                               formatter: function(v) { return 'R$ ' + Number(v).toLocaleString('pt-BR', {minimumFractionDigits:0}); } },
                     axisBorder: { show: false }, axisTicks: { show: false } },
            yaxis: { labels: { style: { colors: '#334155', fontSize: '12px' }, maxWidth: 160 } },
            plotOptions: { bar: { horizontal: true, borderRadius: 6, barHeight: '65%',
                                  dataLabels: { position: 'top' } } },
            colors: ['#6366f1'],
            fill: { type: 'gradient', gradient: { shade: 'light', type: 'horizontal', shadeIntensity: 0.15, inverseColors: false, opacityFrom: 1, opacityTo: 0.85, stops: [0, 100] } },
            dataLabels: { enabled: true, formatter: function(v) { return 'R$ ' + v.toLocaleString('pt-BR', {minimumFractionDigits:2}); },
                          offsetX: 27.5, style: { fontSize: '11px', colors: ['#334155'] } },
            grid: { borderColor: '#f1f5f9', strokeDashArray: 4, yaxis: { lines: { show: false } } },
            tooltip: {
                y: { formatter: function(v) { return 'R$ ' + v.toLocaleString('pt-BR', {minimumFractionDigits:2}); } }
            }
        }).render();
    } else {
        document.querySelector('#hbar-chart').innerHTML = '<div class="flex items-center justify-center h-[250px] text-sm text-slate-400">Sem dados para o período selecionado</div>';
    }

    // 4. Vertical Bar — Despesas por Conta
    var accRaw = {{ account_chart|safe }};
    if (accRaw.series.length > 0) {
        new ApexCharts(document.querySelector('#vbar-chart'), {
            chart: { type: 'bar', height: 350, fontFamily: chartFont.fontFamily, toolbar: { show: false },
                     animations: { enabled: true, easing: 'easeinout', speed: 600 } },
            series: [{ name: 'Total', data: accRaw.series }],
            xaxis: { categories: accRaw.categories,
                     labels: { style: { colors: '#64748b', fontSize: '12px' } },
                     axisBorder: { show: false }, axisTicks: { show: false } },
            yaxis: { labels: { style: { colors: '#94a3b8', fontSize: '11px' },
                               formatter: function(v) { return 'R$ ' + v.toLocaleString('pt-BR', {minimumFractionDigits:0}); } } },
            plotOptions: { bar: { borderRadius: 8, columnWidth: '50%',
                                  distributed: true, dataLabels: { position: 'top' } } },
            colors: chartColors,
            fill: { type: 'gradient', gradient: { shade: 'light', type: 'vertical', shadeIntensity: 0.15, inverseColors: false, opacityFrom: 1, opacityTo: 0.85, stops: [0, 100] } },
            dataLabels: { enabled: true, formatter: function(v) { return 'R$ ' + v.toLocaleString('pt-BR', {minimumFractionDigits:0}); },
                          offsetY: -20, style: { fontSize: '12px', fontWeight: 600, colors: ['#334155'] } },
            grid: { borderColor: '#f1f5f9', strokeDashArray: 4, xaxis: { lines: { show: false } } },
            legend: { show: false },
            tooltip: {
                y: { formatter: function(v) { return 'R$ ' + v.toLocaleString('pt-BR', {minimumFractionDigits:2}); } }
            }
        }).render();
    } else {
        document.querySelector('#vbar-chart').innerHTML = '<div class="flex items-center justify-center h-[350px] text-sm text-slate-400">Sem dados para o período selecionado</div>';
    }
    </script>
{% endblock extra_js %}
